name: "Vercel Deploy"
description: "Deploy to Vercel with reusable configuration"

outputs:
  url:
    description: "The deployment URL"
    value: ${{ steps.deploy.outputs.url }}
  deployment-id:
    description: "The GitHub deployment ID (for finishing deployment later)"
    value: ${{ steps.deployment.outputs.deployment_id }}
  deployment-env:
    description: "The GitHub deployment environment name"
    value: ${{ steps.deployment.outputs.env }}

inputs:
  vercel-token:
    description: "Vercel authentication token"
    required: true
  vercel-org-id:
    description: "Vercel organization ID"
    required: true
  vercel-project-id:
    description: "Vercel project ID"
    required: true
  environment:
    description: "Deployment environment (preview or production)"
    required: false
    default: "preview"
  environment-variables:
    description: "Environment variables for deployment (key=value pairs, one per line)"
    required: false
    default: ""
  meta-branch:
    description: "Branch name for metadata"
    required: false
    default: ""
  meta-pr:
    description: "PR number for metadata"
    required: false
    default: ""
  deployment-env:
    description: "Deployment environment name (e.g., web, docs)"
    required: true
  skip-finish:
    description: "Skip finishing the deployment (use when you need to set a custom env_url later)"
    required: false
    default: "false"
  prebuilt:
    description: "Build locally and deploy prebuilt artifacts (skips remote build on Vercel)"
    required: false
    default: "false"

runs:
  using: "composite"
  steps:
    - name: Start deployment
      id: deployment
      uses: bobheadxi/deployments@v1
      with:
        step: start
        token: ${{ github.token }}
        env: ${{ inputs.environment == 'production' && format('{0}/production', inputs.deployment-env) || format('{0}/preview/{1}', inputs.deployment-env, inputs.meta-branch || github.head_ref || github.ref_name) }}
        ref: ${{ github.head_ref && format('refs/heads/{0}', github.head_ref) || github.ref }}
        desc: Deploying ${{ inputs.environment }} environment

    - name: Setup Vercel
      uses: ./.github/actions/vercel-setup
      with:
        vercel-token: ${{ inputs.vercel-token }}
        vercel-org-id: ${{ inputs.vercel-org-id }}
        vercel-project-id: ${{ inputs.vercel-project-id }}

    - name: Build and Deploy to Vercel
      id: deploy
      shell: bash
      run: |
        ENV_VARS="${{ inputs.environment-variables }}"

        if [ "${{ inputs.prebuilt }}" == "true" ]; then
          # === Prebuilt mode: build locally, deploy artifacts only ===

          # Export environment variables for local build
          if [ -n "$ENV_VARS" ]; then
            echo "Exporting environment variables for local build..."
            while IFS= read -r line; do
              line=$(echo "$line" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
              if [ -n "$line" ]; then
                KEY="${line%%=*}"
                VALUE="${line#*=}"
                echo "Exporting env: $KEY"
                export "$KEY=$VALUE"
              fi
            done <<< "$ENV_VARS"
          fi

          # Build locally using Vercel CLI
          echo "Building locally with vercel build..."
          BUILD_CMD="vercel build --token=${{ inputs.vercel-token }}"
          if [ "${{ inputs.environment }}" == "production" ]; then
            BUILD_CMD="$BUILD_CMD --prod"
          fi
          eval $BUILD_CMD

          # Deploy prebuilt artifacts (no remote build)
          echo "Deploying prebuilt artifacts..."
          DEPLOY_CMD="vercel deploy --prebuilt --token=${{ inputs.vercel-token }}"

          if [ "${{ inputs.environment }}" == "production" ]; then
            DEPLOY_CMD="$DEPLOY_CMD --prod"
          fi

          # Add runtime environment variables
          if [ -n "$ENV_VARS" ]; then
            echo "Adding runtime environment variables..."
            while IFS= read -r line; do
              line=$(echo "$line" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
              if [ -n "$line" ]; then
                KEY="${line%%=*}"
                VALUE="${line#*=}"
                echo "Adding runtime env: $KEY"
                DEPLOY_CMD="$DEPLOY_CMD --env $KEY=\"$VALUE\""
              fi
            done <<< "$ENV_VARS"
          fi
        else
          # === Standard mode: remote build on Vercel ===
          DEPLOY_CMD="vercel deploy --token=${{ inputs.vercel-token }}"

          if [ "${{ inputs.environment }}" == "production" ]; then
            DEPLOY_CMD="$DEPLOY_CMD --prod"
          fi

          # Add environment variables for both build-time and runtime
          if [ -n "$ENV_VARS" ]; then
            echo "Adding environment variables for build and runtime..."
            while IFS= read -r line; do
              line=$(echo "$line" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
              if [ -n "$line" ]; then
                KEY="${line%%=*}"
                VALUE="${line#*=}"
                echo "Adding env: $KEY"
                DEPLOY_CMD="$DEPLOY_CMD --build-env $KEY=\"$VALUE\" --env $KEY=\"$VALUE\""
              fi
            done <<< "$ENV_VARS"
          fi
        fi

        # Add metadata if provided
        if [ -n "${{ inputs.meta-branch }}" ]; then
          DEPLOY_CMD="$DEPLOY_CMD --meta branch=${{ inputs.meta-branch }}"
        fi

        if [ -n "${{ inputs.meta-pr }}" ]; then
          DEPLOY_CMD="$DEPLOY_CMD --meta pr=${{ inputs.meta-pr }}"
        fi

        # Execute deployment and capture URL
        echo "Executing deployment..."
        DEPLOYMENT_URL=$(eval $DEPLOY_CMD)

        # Output the deployment URL
        echo "url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
        echo "Deployment URL: $DEPLOYMENT_URL"

    - name: Finish deployment
      uses: bobheadxi/deployments@v1
      if: always() && inputs.skip-finish != 'true'
      with:
        step: finish
        token: ${{ github.token }}
        status: ${{ job.status }}
        env: ${{ steps.deployment.outputs.env }}
        env_url: ${{ steps.deploy.outputs.url }}
        deployment_id: ${{ steps.deployment.outputs.deployment_id }}
