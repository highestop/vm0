name: Cleanup Resources

on:
  pull_request_target:
    types: [closed]

jobs:
  cleanup-runner:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check if cleanup needed
        id: check
        env:
          METAL_HOST: ${{ secrets.CI_AWS_METAL_RUNNER_HOST }}
          SSH_KEY: ${{ secrets.CI_AWS_METAL_RUNNER_SSH_KEY }}
        run: |
          if [ -z "$SSH_KEY" ] || [ -z "$METAL_HOST" ]; then
            echo "Metal secrets not available, skipping runner cleanup"
            echo "should-cleanup=false" >> $GITHUB_OUTPUT
          else
            echo "should-cleanup=true" >> $GITHUB_OUTPUT
          fi

      - name: Install Ansible
        if: steps.check.outputs.should-cleanup == 'true'
        run: pip install ansible

      - name: Cleanup Runner with Ansible
        if: steps.check.outputs.should-cleanup == 'true'
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          METAL_USER: ${{ secrets.CI_AWS_METAL_RUNNER_USER }}
          METAL_HOST: ${{ secrets.CI_AWS_METAL_RUNNER_HOST }}
          SSH_KEY: ${{ secrets.CI_AWS_METAL_RUNNER_SSH_KEY }}
        run: |
          # Setup SSH key
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/metal.pem
          chmod 600 ~/.ssh/metal.pem

          # Run Ansible cleanup playbook
          cd ansible
          ansible-playbook \
            -i "${METAL_HOST}," \
            playbooks/cleanup-runner.yml \
            --private-key ~/.ssh/metal.pem \
            -e "ansible_user=${METAL_USER}" \
            -e "pr_number=${PR_NUMBER}" \
            -v

  cleanup-database:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/vm0-ai/vm0-toolchain:829341a
    steps:
      - uses: actions/checkout@v4

      - name: Delete Neon Branch
        uses: ./.github/actions/neon-branch
        with:
          neon-api-key: ${{ secrets.NEON_API_KEY }}
          neon-project-id: ${{ vars.NEON_PROJECT_ID }}
          branch-name: "${{ github.event.pull_request.head.ref }}"
          action: "cleanup"

  cleanup-deployments:
    runs-on: ubuntu-latest
    permissions:
      deployments: write
    steps:
      - name: Delete PR Deployments
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = context.payload.pull_request.head.ref;
            const sha = context.payload.pull_request.head.sha;

            console.log(`Cleaning up deployments for branch: ${branchName}, sha: ${sha}`);

            // Get all deployments and filter by branch name
            const allDeployments = await github.rest.repos.listDeployments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            // Filter deployments that belong to this branch
            const branchDeployments = allDeployments.data.filter(deployment => {
              // Match by ref or environment name containing branch
              return deployment.ref === branchName ||
                     deployment.ref === `refs/heads/${branchName}` ||
                     deployment.ref === sha ||
                     deployment.environment?.includes(`preview/${branchName}`);
            });

            console.log(`Found ${branchDeployments.length} deployments to delete`);

            // Delete each deployment (must mark as inactive first)
            for (const deployment of branchDeployments) {
              console.log(`Deleting deployment ${deployment.id} (${deployment.environment})`);

              // Step 1: Mark as inactive
              await github.rest.repos.createDeploymentStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                deployment_id: deployment.id,
                state: 'inactive',
                description: 'PR closed - cleaning up'
              });

              // Step 2: Delete the deployment
              try {
                await github.rest.repos.deleteDeployment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  deployment_id: deployment.id
                });
                console.log(`Successfully deleted deployment ${deployment.id}`);
              } catch (error) {
                console.error(`Failed to delete deployment ${deployment.id}: ${error.message}`);
              }
            }