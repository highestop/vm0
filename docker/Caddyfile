{
	auto_https off
}

:80 {
	# API routes
	handle /api/* {
		reverse_proxy web:3000
	}

	# Public API
	handle /v1/* {
		reverse_proxy web:3000
	}

	# Auth
	handle /sign-in* {
		reverse_proxy web:3000
	}
	handle /sign-up* {
		reverse_proxy web:3000
	}
	handle /cli-auth* {
		reverse_proxy web:3000
	}

	# Platform console redirect
	handle /platform {
		redir {scheme}://{host}:{$PLATFORM_PORT}/ temporary
	}
	handle_path /platform/* {
		redir {scheme}://{host}:{$PLATFORM_PORT}{uri} temporary
	}

	# Default
	handle {
		reverse_proxy web:3000
	}
}

# Platform management console
:3000 {
	# Proxy API calls to web service (same origin, no CORS)
	handle /api/* {
		reverse_proxy web:3000
	}
	handle /v1/* {
		reverse_proxy web:3000
	}

	# All other requests go to platform SPA
	handle {
		reverse_proxy platform:80
	}
}
