# VM0 Shared Service Templates
# Not used directly. Referenced via `extends` from other compose files.

services:
  web-base:
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
    environment:
      NODE_ENV: production
      SELF_HOSTED: "true"
      # Database
      DATABASE_URL: postgresql://${DB_USER:-vm0}:${DB_PASSWORD}@postgres:5432/${DB_NAME:-vm0}
      DB_POOL_MAX: ${DB_POOL_MAX:-10}
      # Object storage (MinIO)
      S3_ENDPOINT: http://minio:9000
      S3_FORCE_PATH_STYLE: "true"
      S3_REGION: us-east-1
      # Public S3 endpoint for presigned URLs (reachable from CLI / browsers)
      S3_PUBLIC_ENDPOINT: http://${DOMAIN:-localhost}:${MINIO_API_PORT:-9000}
      R2_ACCESS_KEY_ID: ${MINIO_USER:-minioadmin}
      R2_SECRET_ACCESS_KEY: ${MINIO_PASSWORD}
      R2_USER_STORAGES_BUCKET_NAME: ${MINIO_BUCKET:-vm0-storages}
      R2_ACCOUNT_ID: local
      # Encryption key (empty = auto-generate on first start)
      SECRETS_ENCRYPTION_KEY: ${SECRETS_ENCRYPTION_KEY:-}
      # Clerk placeholders (required until self-hosted auth is done)
      CLERK_SECRET_KEY: ${CLERK_SECRET_KEY:-placeholder}
      NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY:-placeholder}
      BYPASS_AUTH: "true"
      # E2B (disabled by default, set E2B_ENABLED=true in .env to enable)
      E2B_ENABLED: ${E2B_ENABLED:-false}
      E2B_API_KEY: ${E2B_API_KEY:-}
      # Slack (disabled by default, set SLACK_INTEGRATION_ENABLED=true in .env to enable)
      SLACK_INTEGRATION_ENABLED: ${SLACK_INTEGRATION_ENABLED:-false}
      SLACK_CLIENT_ID: ${SLACK_CLIENT_ID:-}
      SLACK_CLIENT_SECRET: ${SLACK_CLIENT_SECRET:-}
      SLACK_SIGNING_SECRET: ${SLACK_SIGNING_SECRET:-}
      SLACK_REDIRECT_BASE_URL: ${SLACK_REDIRECT_BASE_URL:-}
      # Concurrency
      CONCURRENT_RUN_LIMIT: ${CONCURRENT_RUN_LIMIT:-0}
      # Docker Sandbox (used when E2B is not configured)
      DOCKER_SANDBOX_IMAGE: ${DOCKER_SANDBOX_IMAGE}
      DOCKER_SANDBOX_MEMORY: ${DOCKER_SANDBOX_MEMORY:-2g}
      DOCKER_SANDBOX_CPUS: ${DOCKER_SANDBOX_CPUS:-2}
      # Claude Code
      CLAUDE_CODE_VERSION_URL: ${CLAUDE_CODE_VERSION_URL:-https://storage.googleapis.com/claude-code-dist-86c565f3-f756-42ad-8dfa-d59b1c096819/claude-code-releases/latest}
      # Platform console
      PLATFORM_PORT: ${PLATFORM_PORT:-3001}
      NEXT_PUBLIC_PLATFORM_URL: http://${DOMAIN:-localhost}:${PLATFORM_PORT:-3001}
    volumes:
      - web_data:/app/data
      # Docker socket for creating sandbox containers (Docker Sandbox executor)
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - vm0

  platform-base:
    restart: unless-stopped
    depends_on:
      - web
    networks:
      - vm0
